feature nxapi
nv overlay evpn
feature ospf
feature bgp
feature pim
feature pbr
feature interface-vlan
feature vn-segment-vlan-based
feature lacp
feature dhcp
feature lldp
feature nv overlay
feature ngoam

#for loop to configure physical fabric interfaces
{% for interface in fabric_interfaces %}
interface {{interface['interface']}}
  no switchport
  description {{interface['description']}}
  mtu 9216
  ip address {{interface['ip_add']}}
  ip ospf network point-to-point
  ip router ospf UNDERLAY area 0.0.0.0
  ip pim sparse-mode
  no shutdown
{% endfor %}

interface loopback0
  ip address {{loopback0}}
  ip router ospf UNDERLAY area 0.0.0.0
  ip pim sparse-mode
interface loopback1
  ip address {{loopback1}}
  ip router ospf UNDERLAY area 0.0.0.0
  ip pim sparse-mode

ip pim rp-address {{rp_address}}

{% for L2VNI in L2VNI %}
vlan {{L2VNI['vlan_id']}}
  name {{L2VNI['vlan_name']}}
  vn-segment {{L2VNI['vni']}}
!
{% endfor %}
{% for L3VNI in L3VNI %}
vlan {{L3VNI['vlan_id']}}
  vn-segment {{L3VNI['vni']}}
vrf context Tenant-1
  vni {{L3VNI['vni']}}
  rd auto
  address-family ipv4 unicast
    route-target both auto
    route-target both auto evpn
!
{% endfor %}
fabric forwarding anycast-gateway-mac 0000.2222.3333
!
#for loop to configure SVIs
{% for L2VNI in L2VNI %}
interface vlan{{L2VNI['vlan_id']}}
  no shutdown
  vrf member Tenant-1
  no ip redirects
  ip address {{L2VNI['ip_add']}}/{{L2VNI['mask']}}
  fabric forwarding mode anycast-gateway
  !
{% endfor %}
{% for L3VNI in L3VNI %}
interface vlan{{L3VNI['vlan_id']}}
  no shutdown
  vrf member Tenant-1
  ip forward
  !
{% endfor %}

router ospf UNDERLAY
  router-id {{ router_id }}

router bgp {{ asn }}
  router-id {{ router_id }}
  address-family l2vpn evpn
#for loop to configure bgp neighbor with spines
{% for neighbor in bgp_neighbors %}
  neighbor {{neighbor['neighbor']}}
    remote-as {{neighbor['remote_as']}}
    update-source {{neighbor['update_source']}}
    address-family l2vpn evpn
      send-community
      send-community extended
!
{% endfor %}
